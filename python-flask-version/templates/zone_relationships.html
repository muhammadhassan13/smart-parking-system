{% extends 'base.html' %}

{% block title %}Zone Relationships - IntelliCity | Smart Parking{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary mb-0">Zone Relationships Map</h2>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Total Zones</h5>
                <h2>{{ relationships.total_zones }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Total Connections</h5>
                <h2>{{ relationships.total_connections }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Network Type</h5>
                <h2>Bidirectional</h2>
            </div>
        </div>
    </div>
</div>

<!-- Zone Network Visualization -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header border-bottom-0">
                <h5 class="mb-0 fw-bold header-triad">Core Network Triad
                    <small class="text-muted fw-normal ms-2">(Conceptual View)</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="zone-graph-container"
                    style="min-height: 400px; position: relative; background: #f8fafc; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);">
                    <svg id="zone-graph" width="100%" height="400" viewBox="0 0 800 400">
                        <!-- Definitions for High-End Effects -->
                        <defs>
                            <linearGradient id="grad-z1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="grad-z2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#34d399;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="grad-z3" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                            </linearGradient>
                        </defs>

                        <style>
                            .header-triad {
                                color: var(--primary-color) !important;
                            }

                            @keyframes float {

                                0%,
                                100% {
                                    transform: translateY(0px);
                                }

                                50% {
                                    transform: translateY(-6px);
                                }
                            }

                            @keyframes flow {
                                0% {
                                    stroke-dashoffset: 20;
                                    opacity: 0.4;
                                }

                                50% {
                                    opacity: 0.7;
                                }

                                100% {
                                    stroke-dashoffset: 0;
                                    opacity: 0.4;
                                }
                            }

                            .node-group {
                                cursor: pointer;
                                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), filter 0.3s ease;
                            }

                            .node-group:hover {
                                transform: translateY(-4px) !important;
                                filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.1));
                            }

                            .link-line {
                                stroke: var(--primary-color);
                                stroke-width: 1.5;
                                stroke-opacity: 0.2;
                                stroke-dasharray: 4, 4;
                                animation: flow 8s linear infinite;
                            }

                            .floating {
                                animation: float 8s ease-in-out infinite;
                            }

                            .floating-delayed-1 {
                                animation: float 8s ease-in-out infinite -2s;
                            }

                            .floating-delayed-2 {
                                animation: float 8s ease-in-out infinite -4s;
                            }
                        </style>

                        <!-- Connections (Edges) -->
                        <g id="connections">
                            <!-- Z1 <-> Z2 -->
                            <line x1="250" y1="150" x2="550" y2="150" class="link-line" />
                            <!-- Z2 <-> Z3 -->
                            <line x1="550" y1="150" x2="400" y2="300" class="link-line" />
                            <!-- Z1 <-> Z3 -->
                            <line x1="250" y1="150" x2="400" y2="300" class="link-line" />
                        </g>

                        <!-- Nodes (Zones) -->
                        <!-- Z1: Downtown -->
                        <g class="node-group floating" transform="translate(0,0)">
                            <circle cx="250" cy="150" r="30" fill="url(#grad-z1)" />
                            <text x="250" y="155" text-anchor="middle" fill="white" font-weight="bold"
                                font-size="16">Z1</text>
                            <text x="250" y="200" text-anchor="middle" fill="#2563eb" font-size="12"
                                font-weight="600">DOWNTOWN</text>
                        </g>

                        <!-- Z2: Uptown -->
                        <g class="node-group floating-delayed-1" transform="translate(0,0)">
                            <circle cx="550" cy="150" r="30" fill="url(#grad-z2)" />
                            <text x="550" y="155" text-anchor="middle" fill="white" font-weight="bold"
                                font-size="16">Z2</text>
                            <text x="550" y="200" text-anchor="middle" fill="#059669" font-size="12"
                                font-weight="600">UPTOWN</text>
                        </g>

                        <!-- Z3: Midtown -->
                        <g class="node-group floating-delayed-2" transform="translate(0,0)">
                            <circle cx="400" cy="300" r="30" fill="url(#grad-z3)" />
                            <text x="400" y="305" text-anchor="middle" fill="white" font-weight="bold"
                                font-size="16">Z3</text>
                            <text x="400" y="350" text-anchor="middle" fill="#dc2626" font-size="12"
                                font-weight="600">MIDTOWN</text>
                        </g>

                        <!-- Legend Overlay -->
                        <rect x="20" y="20" width="160" height="85" rx="10" fill="white" stroke="var(--border-color)"
                            stroke-width="1" />
                        <text x="35" y="45" fill="var(--text-muted)" font-size="10" font-weight="bold">NETWORK
                            LEGEND</text>
                        <circle cx="40" cy="65" r="4" fill="#60a5fa" />
                        <text x="52" y="69" fill="var(--text-main)" font-size="11">Active Node</text>
                        <line x1="36" y1="82" x2="44" y2="82" stroke="var(--primary-color)" stroke-width="2"
                            stroke-dasharray="2,1" stroke-opacity="0.5" />
                        <text x="52" y="86" fill="var(--text-main)" font-size="11">Data Flow</text>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Zone Details Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 fw-bold">Zone Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light text-primary">
                            <tr>
                                <th>Zone ID</th>
                                <th>Zone Name</th>
                                <th>Total Slots</th>
                                <th>Available Slots</th>
                                <th>Utilization</th>
                                <th>Adjacent Zones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for zone in relationships.zones %}
                            <tr>
                                <td><span class="badge bg-primary">{{ zone.zone_id }}</span></td>
                                <td>{{ zone.zone_name }}</td>
                                <td>{{ zone.total_slots }}</td>
                                <td>
                                    <span
                                        class="badge {% if zone.available_slots > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ zone.available_slots }}
                                    </span>
                                </td>
                                <td>
                                    {% set utilization = (((zone.total_slots - zone.available_slots) * 100 /
                                    zone.total_slots) | round(1)) if zone.total_slots > 0 else 0 %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if utilization > 80 %}bg-danger{% elif utilization > 50 %}bg-warning{% else %}bg-success{% endif %}"
                                            role="progressbar" data-width="{{ utilization }}%"
                                            aria-valuenow="{{ utilization }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ utilization }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% for adj in zone.adjacent_zones %}
                                    <span class="badge bg-secondary">{{ adj }}</span>
                                    {% endfor %}
                                    {% if not zone.adjacent_zones %}
                                    <span class="text-muted">None</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection List -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Zone Connections</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for conn in relationships.connections %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <span class="badge bg-primary">{{ conn.from }}</span>
                            {{ conn.from_name }}
                            <i class="bi bi-arrow-left-right mx-2"></i>
                            <span class="badge bg-primary">{{ conn.to }}</span>
                            {{ conn.to_name }}
                        </span>
                        <span class="badge bg-success">Bidirectional</span>
                    </li>
                    {% endfor %}
                    {% if not relationships.connections %}
                    <li class="list-group-item text-muted">No connections defined</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Cross-Zone Allocation Rules</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> How Cross-Zone Allocation Works:</h6>
                    <ol class="mb-0">
                        <li>When a requested zone is full, the system first tries <strong>adjacent zones</strong></li>
                        <li>If no adjacent zone has available slots, it uses <strong>round-robin</strong> to find any
                            available zone</li>
                        <li>Cross-zone allocations incur an <strong>extra cost/penalty</strong></li>
                    </ol>
                </div>
                <div class="mt-3">
                    <h6>Priority Order:</h6>
                    <ol>
                        <li>Same zone (preferred)</li>
                        <li>Adjacent zones (nearby)</li>
                        <li>Any available zone (fallback)</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
<script>
    // Apply dynamic widths to progress bars to avoid CSS syntax errors in templates
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.progress-bar[data-width]').forEach(function (bar) {
            bar.style.width = bar.getAttribute('data-width');
        });
    });
</script>
{% endblock %}